<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<!-- Plugin "CopyScript" generated by Plugin Wizard -->

<!-- Amended slightly by Nick Gammon, from Worstje's version, on 17 Feb 2008 -->
<!-- Refactored by Asmodeus for the CleftMUSH client package-->

<muclient>
<plugin
   name="CleftMUSH_MudBin"
   author="Pwar"
   id="04d9e64f834452b145b459b7"
   language="Lua"
   purpose="Copies and posts to a mudbin link"
   save_state="n"
   date_written="2008-07-28"
   requires="4.00"
   version="1.1"
   >

<description trim="y">
Copies text from the output window to the clipboard.
Pastes to mudbin at:
http://mudbin.tk/

To use: highlight text and then:

Ctrl+P copy and posts to mudbin (like Ctrl+C but different)

</description>

</plugin>

<aliases>
</aliases>

<!--  Script  -->

<script>
<![CDATA[
local mudbin_url = "http://mudbin.tk/"
local async = require "async"

-- functions for handling Cleft color codes and posting to the website as Aard colors
dofile (GetPluginInfo (GetPluginID(), 20) .. "aardwolf_colors.lua")


-- Thank you, Shaun Biggs, for taking your time to write the CopyScript
-- (formerly Copy2) function below. It was slightly altered by me to suit
-- my usage (wordwrapped lines and no \r\n at start of selection). -- Nick Gammon

-- And then I ripped out its heart because handling color is its own beast. :) -- Fiendish
-- And then I took the whole thing and used it for my mudbin ;D --Pwar

function CopyScript(name, line, wildcs)

   -- find selection in output window, if any
   local first_line, last_line = GetSelectionStartLine(),
                        math.min (GetSelectionEndLine(), GetLinesInBufferCount ())
   local first_column, last_column = GetSelectionStartColumn(), GetSelectionEndColumn()

   -- nothing selected, do normal copy
   if first_line <= 0 then
      DoCommand("copy")
      return
   end -- if nothing to copy from output window

   cpstr = ""

   -- iterate to build up copy text
   for line = first_line, last_line do
      if line < last_line then
         cpstr = cpstr..StylesToColoursOneLine (GetStyleInfo(line), first_column, GetLineInfo(line).length)
         first_column = 1

         -- Is this a new line or merely the continuation of a paragraph?
         if GetLineInfo (line, 3) then
            cpstr = cpstr .. "\r\n"
         end  -- new line
      else
         cpstr = cpstr..StylesToColoursOneLine (GetStyleInfo(line), first_column, last_column-1)
      end
   end

   -- Get rid of a spurious extra new line at the start.
   if cpstr:sub (1, 2) == "\r\n" then
      cpstr = cpstr:sub (3)
   end

  -- finally can set clipboard contents
  PostText(cpstr)
end

function PostText(text)
   async.doAsyncRemoteRequest(mudbin_url .. "documents", mudbin_upload_complete, "HTTP", 120, nil, text)
end

function mudbin_upload_complete(retval, page, status, headers, full_status, request_url)
   if tonumber(status) == 200 then
      local link = mudbin_url .. string.match(page, '^{"key":"(.+)"}$')
      SetClipboard(link)
      ColourNote("CornFlowerBlue", "", "*** Posted clipboard contents to mudbin")
      ColourTell("CornFlowerBlue", "", "*** ")
      Hyperlink(link, link, "[mudbin link]", "cornflowerblue", "", true)
      ColourTell("CornFlowerBlue", "", " has been copied. Press CTRL+V to paste.")
      print("")
   else
      print("Failed to post clipboard contents to site. Error code " .. code)
   end
   --print(status)
   --print(page)
end

ColourNote("CornFlowerBlue", "", "*** CleftMUSH MudBin plugin has been loaded. Select text in the main window and press Ctrl+P to use.")

AcceleratorTo ("Ctrl+P", "CallPlugin ('04d9e64f834452b145b459b7', 'CopyScript', '')", sendto.script)

]]>
</script>
</muclient>
